<!-- Paul Sco               tti 2018
originally modified from Tim Brady https://timbrady.org/turk/ensembleindivdiff/e9/  -->



<!-- Preload javascript and css files -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<script src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/jquery.min.js"></script>
<script src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/seedrandom.js"></script>
<script src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/TimTurkTools.js"></script>
<script src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/jcanvas.min.js"></script>
<script src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/chance.js"></script>
<script src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/lodash.core.js"></script> <!-- Allows _clone -->

<!-- load Firebase server javascript, we are using it for storage -->
<script src="https://www.gstatic.com/firebasejs/5.0.1/firebase.js"></script>

<link rel="stylesheet" type="text/css" href="https://paulscotti.github.io/mturk/Cont_LTM_101_files/contReport.css">
<link rel="stylesheet" type="text/css" href="https://paulscotti.github.io/mturk/Cont_LTM_101_files/showTrials.css">
<link rel="stylesheet" type="text/css" href="https://paulscotti.github.io/mturk/Cont_LTM_101_files/experiment.css">

</head>
<body style="">

<!-- Consent statement: -->
<div id="consentDiv"><h1>The Ohio State University Consent to Participate in Research</h1><h2>Study Title: Individual variation in attention, cognitive control, and memory</h2><h2>Researchers: Paul S. Scotti, Yoolim Hong, Julie D. Golomb, Andrew B. Leber</h2> <p><b>This is a consent form for research participation.</b> It contains important information about this study and what to expect if you decide to participate.</p><p><b>Your participation is voluntary.</b></p><p>Please consider the information carefully. Feel free to email questions to the researchers before making your decision whether or not to participate.  If you decide to participate, you will be asked to click a button below this form.</p><p><b>Purpose:</b> In this experiment, we are interested in understanding how humans are able to control their attention to focus on relevant information, and how attention is related to other cognitive abilities and traits.</p><p><b>Procedures/Tasks:</b> Your participation involves watching various visual events on a computer screen and responding to what you saw. Additionally, you may be asked to complete a survey. You will be provided with detailed written instructions at the start of each task or survey.</p><p><b>Duration:</b> The experiment is expected to take the duration listed in the HIT description. You may leave the study at any time.  If you decide to stop participating in the study, there will be no penalty to you, and you will not lose any benefits to which you are otherwise entitled.  Your decision will not affect your future relationship with The Ohio State University.</p><p><b>Risks and Benefits:</b> There is no more risk associated with participation than you would normally encounter while playing a simple video game.  Benefits include advance scientific knowledge, experiencing the research process, and learning about attention and cognitive control.</p><p><b>Confidentiality:</b> Upon completed of the HIT, your Amazon Mechanical Turk Worker ID will be made available to the experimenters. Only select lab personnel will have access to the requester Mechanical Turk site, and Worker IDs will be used only to confirm study completion, assign compensation, and, in some cases, to invite you to participate in a follow-up study.</p><p>The data that you provide in the experiment will be stored temporarily on a secure private online server or on the web-survey platform Qualtrics, then transferred to our secure lab computers. Your name or contact information will not be collected during the experiment. Only select lab personnel who have received training in human subjects protection and clearance to handle data for this project will have access to your results. We will work to make sure that no one sees your data without approval. But, because we are using the Internet, there is a chance that someone could access your online responses without permission. In some cases, this information could be used to identify you. Your data will be protected with a code to reduce the risk that other people can view the responses. However, there are rare instances when the researcher may be required to share personally identifiable information. For example, in response to a complaint about the research, officials at The University and/or regulatory oversight government agencies (National Science Foundation) may access research data.  The researcher is also required by law to report certain information to government and/or law enforcement officials (e.g., threatened violence against self or others, communicable diseases).</p><p><b>Incentives:</b> You will receive the compensation amount listed in the HIT description (based on a rate of $6/hour). If you withdraw early for any reason, your payment will be prorated to the nearest increment of 10 minutes based on a $6/hour rate, up until the amount indicated in the HIT description. If you withdraw early, please contact the researcher at scotti.5@osu.edu to ensure you receive your compensation.</p><p><b>Participant Rights:</b> You may refuse to participate in this study without penalty or loss of benefits to which you are otherwise entitled. If you are a student or employee at Ohio State, your decision will not affect your grades or employment status.</p><p>If you choose to participate in the study, you may discontinue participation at any time without penalty or loss of benefits.  By consenting below, you do not give up any personal legal rights you may have as a participant in this study.</p><p>An Institutional Review Board responsible for human subjects research at The Ohio State University reviewed this research project and found it to be acceptable, according to applicable state and federal regulations and University policies designed to protect the rights and welfare of participants in research.</p><p><b>Contacts and Questions:</b> For questions, concerns, or complaints about the study, or you feel you have been harmed as a result of study participation, you may contact either Paul Scotti at scotti.5@osu.edu. For questions about your rights as a participant in this study or to discuss other study-related concerns or complaints with someone who is not part of the research team, you may contact Ms. Sandra Meadows in the Office of Responsible Research Practices at meadows.8@osu.edu.</p><p><b>Electronic consent:</b> You may print a copy of this consent form for your records. If you wish to continue with the experiment, please click the button below.<br><center><b>Clicking the button below indicates that:</b><br>You have read the above information<br>You are 18 years of age or older<br>You voluntarily agree to participate<br></p><br></center><p style="text-align: center"><a href="javascript:void(0);" onclick="$('#consentDiv').hide();$('#instructions').show();document.body.scrollTop = document.documentElement.scrollTop = 0;" id="startExperimentButton" style="display: inline;">I consent to participate in this study</a></p></div>

<!-- Instructions: -->
<div id="instructions" style="display: none">
<p><b><center>This HIT lasts approximately one and a half hours.</center><br>You will receive $9.00 for HIT completion. Depending on performance you may receive a bonus up to $3.60.<br>If you have previously completed this HIT then you are ineligible to participate.</b><br>Please do not disable the creation of text dialogs as these will sometimes be used to relay instructions.</p><br>
<p>In this HIT, you will memorize the colors of a variety of objects.</p>
<p>Every object has a single color associated with it. For example:</p>
<p align="center"><img src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/Instruct1.png" width="400"></p>
<p>An object will be displayed for one second, followed by a blank delay. This will repeat until you have seen 40 objects.</p>

<p>You will then be tested on your memory for each object's color. A previously seen object will be presented on the screen and you will be required to move your mouse around a color wheel to select your best guess of the original color of the object. Once you feel you have matched the correct color of the object, click using your mouse to lock in your answer and move on to the next object.</p>

<p align="center"><img src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/Instruct2.png" width="400"></p>

<p>It is important that you be as <em>precise and as accurate as possible</em> when reporting the original colors of the objects. Also note that since this is an experiment designed to study memory, we require that you <strong>do not take any breaks after starting this study</strong>.</p>

<p>If you do not know the correct color, move your mouse around the color wheel and select what feels right. You are not allowed to use any external tools to remember objects.</p>

<p>After you have selected your best guess, you will be asked to highlight the region of the color wheel that represents how certain you are about your answer. That is, the colors contained in this highlighted portion (shown as a black border around the color wheel) represent the smallest range of colors you think could contain the original object's color. If you believed the original color to be somewhere between red and purple then you would highlight that portion of the color wheel. If you were very certain about your answer then you would highlight a small range of colors, and if you were completely guessing then you would highlight the entirety of the color wheel.</p>

<p align="center"><img src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/Instruct3.png" width="400"></p>

<p>After you have been tested on all 40 objects, the entire process repeats. That is, you will study and be tested on another 40 objects.</p>

<p><strong>To start off with, we'll give you a few practice trials</strong>. During practice, you will see colored objects presented one at a time. Remember to memorize the colors associated with each object. After you have seen all the practice objects, you will then be asked to report the original colors of the objects. Please take your time to respond as accurately as possible; the hour and a half time estimate assumes a patient worker who takes their time for every reponse!</p>

<p style="text-align: center"><a href="javascript:void(0);" onclick="StartExperiment();document.body.scrollTop = document.documentElement.scrollTop = 0;" id="startExperimentButton" style="display: inline;">Start Experiment</a><span id="loading" style="display: none;">Images still loading. Please wait. &nbsp; &nbsp; <img src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/spinner.gif" style="width: 30px; height: 30px"></span></p>
</div>

<!-- Start form here to capture comments -->
<form name="turkSubmit" id="turkSubmit" action="https://workersandbox.mturk.com/mturk/externalSubmit" method="POST">
<input type="hidden" name="assignmentId" id="assignmentId" value="" >
<input type="hidden" name="foo" value="" >
<input type="submit" value="Submit" name="submitButton" id="submitButton" style="display: none"></form>
<!-- submit to turk
https://workersandbox.mturk.com/mturk/externalSubmit
https://www.mturk.com/mturk/externalSubmit
-->

<!-- Screen for collecting comments when they are done: -->
<div id="done"><div id="doneText">Thanks very much for your participation! Your bonus may take a few extra days to process.<br><br>Any comments for us? (Was it fun? Any technical difficulties?)<br><br>
<textarea name="comments" id="comments" style="width: 400px; height: 300px"></textarea>
<center><p><div id="cashPrize">text</center></div></p>
<a href="javascript:void(0);" onclick="SaveData()" id="submitForm">Click to Submit HIT</a>
</div><div id="saving">Saving . . .</div></div>

<!-- Basic structure for a trial: -->
<div id="showTrial">
<div id="fixation">+</div>
<div id="allItems">
<canvas id="item" width=600 height=600></canvas>
<canvas id="CDitem" width=600 height=600></canvas>
</div><br><br>
<center><a href="javascript:void(0);" onclick="SamePress();ChangeDetection();" id="SameButton" style="display: hidden; ">Same</a>
<a href="javascript:void(0);" onclick="DiffPress();ChangeDetection();" id="DiffButton" style="display: hidden;">Different</a>
<div id="underText2"><p>Did this square stay the same color or change to a different color?</p></div></center>
</div>

<!-- Structure for continuous report after the trial: -->
<div id="continuousReport">
<canvas id="contItem"  width=600 height=600 style="position: absolute; left: 0; top: 0;"></canvas>
<canvas id="ringItem"  width=600 height=600 style="position: absolute; left: 0; top: 0;"></canvas>
<div id="pointer"></div>
<div id="popQuiz"><p>What was the color of this object?/p></div>
<div id="underText"><p></p></div>
</div>

<!-- feedback -->
<div id="feedback">
    <div id="feedbackReportedText">Your response:</div><canvas id="feedbackReportedTri" width=300 height=300></canvas><div id="feedbackCorrectText">Correct response:</div><canvas id="feedbackCorrectTri" width=300 height=300></canvas><div id="feedbackError">Your error was: 10 deg (aim for less than 10 degrees!).<br>Click to continue.</div></div>

<form id="survey1" style="display: none;">
    <center>
    <div id = "doneText"><p>You finished! Just a few questions before you go:<p><br><p>What strategy (if any) did you use when selecting the colors of objects?</p></div>
    <br><br><br><br>
    <textarea name="strategy" id="strategy" style="width: 400px; height: 200px"></textarea><br><br>
    <a href="javascript:void(0);" onclick="Survey2();" id="startExperimentButton" style="display: inline;">Submit</a>
    </center>
</form>

<form id="survey2" style="display: none;">
    <center>
    <div id = "doneText"><p>Do you think object colors were sampled randomly from the color wheel or do you think objects often shared approximately the same color?</p></div>
    <br><br><br><br>
    <input name="choice" type="radio" value="nope" id="surveyresponseRand" /> Each color chosen at random
    <br><br>
    <input name="choice" type="radio" value="yes" id="surveyresponsePref" /> Some portion of colors chosen more than others
    <br><br><br><br>
    <a href="javascript:void(0);" onclick="Survey();" id="startExperimentButton" style="display: inline;">Submit</a>
    </center>
</form>

<form id="survey3" style="display: none;">
    <center>
    <div id = "doneText"><p>How confident are you that the biased color region you selected is close to the actual experimental manipulation?</p></div>
    <br><br><br><br>
    <div class="likertButtons">
    Less certain
    <label for="likert1">1<input id="likertConfidence" type="radio" name="likertz" value="1"></label>
    <label for="likert2">2<input id="likertConfidence" type="radio" name="likertz" value="2"></label>
    <label for="likert3">3<input id="likertConfidence" type="radio" name="likertz" value="3"></label>
    <label for="likert4">4<input id="likertConfidence" type="radio" name="likertz" value="4"></label>
    <label for="likert5">5<input id="likertConfidence" type="radio" name="likertz" value="5"></label>
    <label for="likert6">6<input id="likertConfidence" type="radio" name="likertz" value="6"></label>
    More certain
    </div>
    <br><br>
    <a href="javascript:void(0);" onclick="Done();" id="startExperimentButton" style="display: inline;">Submit</a></center>
</form>

<!-- Preload images, needs to be below divs -->
<script src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/loadimg.js"></script>

<script>
let WORKERID = (IsOnTurk())? GetWorkerId() : prompt("You don't look like an mTurker! " +
"Enter an ID to save your data with (any number/string will do). Note your id is used to seed the experiment rng:", "workID");
let ASSIGNMENTID = (IsOnTurk())? GetAssignmentId() : prompt("Set assignment number (doesnt matter for testing):", "assignmentId");

// Initialize Firebase
const config = {
    apiKey: "AIzaSyDwjzBVfuVrD3QmIg6fj0yVyfuqXFCSYCU",
    authDomain: "yoolimhong-3c98d.firebaseapp.com",
    databaseURL: "https://yoolimhong-3c98d.firebaseio.com",
    projectId: "yoolimhong-3c98d",
    storageBucket: "yoolimhong-3c98d.appspot.com",
    messagingSenderId: "385097607192"
};
firebase.initializeApp(config);

/* disable context menu */
// document.oncontextmenu = function() {
//     return false;
// }

const chance1 = Chance(WORKERID); // Use their ID as the shuffle seed, so you can trace back their trials

/* Options: */
const totalRepeats = 0; // 30 need be factor of r_TrialType.length (in this case it's 5)
const numTrialsPerPart = [2, 5, 5]; // [5, 360, 360] prac, study (nonrepeat), test (should = study); 240 tested nonrepeat trials
let block = 1;
const trialsPerBlock = 5;
const totBlocks = numTrialsPerPart[1]/trialsPerBlock;
</script> <script src="https://paulscotti.github.io/mturk/Cont_LTM_101_files/colors_blocked.js"> </script>

<script>

let imgNum = 0;
const imgWidth = 250;
const imgHeight = 250;
const displayTime = 1000;
const isiTime = 1000;
const origColors = _.clone(colors); // clone is required to copy a variable without it accidentally referencing the same thing
let flippedColors = _.clone(colors).reverse();
flippedColors = flippedColors.concat(flippedColors.splice(0,180)); // shift array 180

let practiceTriTrials = [];
let triTrials = [];
let triTrialsTest = [];
let repeatTriTrials = [];
let totalTrials = [];
let r_totalTrials = [];

/* Pointers for where we are in the experiment: */
let currentTrial = -1;
let currentPart = 0;
let currentFeedTrial = -1;
let nextTrialStart = 1;
let feedbackPhase = 0;
let repeat = 0;
let numRepeats = 0;
let mouseClick = -1;
let randrotate = 0;
let angleDeg = 0; let angleDeg2 = 0; let angleDeg3 = 0;
let curAngle = 0;
let curError = 360;
let seed = [];
let flip = 0;
let survey = 0;
let readyRepeat = 0;
let waitObject = 0;
const radius = 242;
const ringSize = 242;
const centerX = 300; const centerY = 300;
let points = 0;
let feedText = '';
let basepay = 9;
let radioResp = 0;
let likertAns = 0;
let explicitColor = -999;
const startExpTime = new Date();
let mouseMoved = 0;
let startTime = -999;
let startingColor = -999;
let startAngle = -999; let startAngle2 = -999;
let diffAng2 = -999; let diffAng3 = -999;
let lastRot = -999; let lastRotMat = [];
let noMore = -999;
let relX = -999;
let relY = -999;
let parentOffset = -999;
let blockStart = 0;
let numCD = 0;
let CDtrial = 0; let sameTally = -1; let diffTally = -1;
let CDaccuracy = [];
let tooFast = [];
let tempVar = true;
let age = 0;
let sex = -999;

/* Randomize orderings */
dx.r_study = chance1.shuffle(dx.r_study);
dx.rep_TrialType = chance1.shuffle(dx.rep_TrialType);
dx.r_repeattrial = chance1.shuffle(dx.r_repeattrial);
dx.r_repeattrial = dx.r_repeattrial.splice(dx.r_repeattrial.length-totalRepeats); //determine which trials will be repeat trials (equals totalRepeats)

/* Setup reused image variable */
let img = new Image();
img.crossOrigin = "anonymous";
let imgX = new Image();
imgX.crossOrigin = "anonymous";
let imgPop = new Image();
imgPop.crossOrigin = "anonymous";

/* Setup ring image */
let ringImg = new Image();
ringImg.crossOrigin = "anonymous";
ringImg.src = $('#ring')[0].src;

/* Setup CD images */
let imgCD = new Image();
imgCD.crossOrigin = "anonymous";
imgCD.src = $('#diff1')[0].src;
let CDfix = new Image();
CDfix.crossOrigin = "anonymous";
CDfix.src = $('#CDfixation')[0].src; //lowercase CDfixation refers to the actual image, CDFixation refers to the class
let imgCDtest = new Image();
imgCDtest.crossOrigin = "anonymous";
imgCDtest.src = $('#diff2')[0].src;

/* Setting up canvas contexts */
const item = document.getElementById("item");
const ctx = item.getContext("2d");
const contItem = document.getElementById("contItem");
const ctx2 = contItem.getContext("2d");
const feedbackReportedTri = document.getElementById("feedbackReportedTri");
const ctx3 = feedbackReportedTri.getContext("2d");
const feedbackCorrectTri = document.getElementById("feedbackCorrectTri");
const ctx4 = feedbackCorrectTri.getContext("2d");
const ringItem = document.getElementById("ringItem");
const ringctx = ringItem.getContext("2d");
const CDitem = document.getElementById("CDitem");
const cdctx = CDitem.getContext("2d");


imgX.src = $('#' + dx.pracimg[0])[0].src;
// imgPop.src = $('#' + dx.repeatimg[numRepeats])[0].src;

/* Start by hiding text */
$('#popQuiz').hide();
$('#underText2').hide();

/* Generate trials: Do it the same for each subject by seeding the random number generator the same every time. */
function GenerateTrials() {
  if (WORKERID == null) {
    WORKERID = 'no_id';
  }
  if (typeof ASSIGNMENTID === 'undefined') {
    assignmentId = 'no_assignment';
  }
  if (typeof WORKERID === 'undefined') {
    workerId = 'no_workerId';
  }
  Math.seedrandom(WORKERID); /* Use their ID as the Math random seed generator, so you can trace back their trials */

  seed = Math.floor(Math.random()*360);
  seed = [seed, (seed + 90)];
  seed = [seed[0], seed[1], (seed[1] + 90)];
  seed = [seed[0], seed[1], seed[2], (seed[2] + 90)];
  wrap(seed);

  for (let i=0; i<numTrialsPerPart[1]; i++) {
    let pickSeed = dx.r_TrialType[i];
    let curMean = seed[pickSeed] + (Math.floor(Math.random()*90) - 45);
    wrap(curMean);
    triTrials.push({'mean': seed[pickSeed],
                    'seed': pickSeed,
                    'isPractice': 0,
                    'item': curMean,
                    'itemID': dx.r_study[i],
                    'origTrial': i});
  }

  for (let blockNum=0; blockNum<=totBlocks; blockNum++) {
    let tempTest = _.clone(triTrials.slice(trialsPerBlock*blockNum,trialsPerBlock*(blockNum+1)));
    triTrialsTest.push.apply(triTrialsTest,chance1.shuffle(tempTest));
  }

  for (let i=0; i<numTrialsPerPart[0]; i++) {
    let cap = 360/numTrialsPerPart[0];
    let curMean = counter(1,360,cap);
    practiceTriTrials.push({'isPractice': 1,
                    'item': curMean[i]});
  }

  for (let i=0; i<dx.rep_TrialType.length; i++) {
    let pickSeed = dx.rep_TrialType[i];
    let curMean = seed[pickSeed] + (Math.floor(Math.random()*90) - 45);
    wrap(curMean);
    repeatTriTrials.push({'mean': seed[pickSeed],
                    'seed': pickSeed,
                    'isPractice': 0,
                    'item': curMean,
                    'origTrial': dx.r_repeattrial[i] + 1});
  }
    repeatTriTrials = chance1.shuffle(repeatTriTrials);
}

/* Start the experiment, this function is the first to operate! */
function StartExperiment() {
  if (IsOnTurk() && IsTurkPreview()) {
    alert("Please accept the HIT before continuing.");
    return false;
  }
  GenerateTrials();

  age = prompt('Before we start, can you tell me how old you are (in years)?');

  while (!(age >0)) {
    age = prompt('Can you tell me how old you are (in years)?');
  }

  sex = prompt('And are you male (M) or female (F) or other (O)?');

  while (!(sex == 'M' || sex == 'F' || sex == 'O' || sex == 'm' || sex == 'f' || sex == 'o' || sex == 'female' || sex == 'male' || sex == 'Female' || sex == 'Male')) {
      sex = prompt('Are you male (M) or female (F) or other (O)?');
  }
  alert('Thanks! You will now see colored objects appear one at a time. Remember their colors!')

  r_totalTrials = [practiceTriTrials, triTrials, triTrialsTest];

  $('#instructions').hide();
  NextTrial();
}

/* Show the next trial or show the done screen if they are finished: */
function NextTrial() {
  repeat = 0;
  currentTrial++;

  if (nextTrialStart == 0) {
    if (currentTrial>=numTrialsPerPart[currentPart] && currentPart == 0) {
      alert("You will now see previously displayed objects again, one at a time. Please move your mouse around the color wheel to adjust the color of the object until it matches its original color (please be as precise as possible). Then click to lock in your response.\n\nPress [ENTER] to continue.");
      if (currentPart == 1) {
        currentPart = 2;
      }
      $('#showTrial').hide();

      nextTrialStart = 1;
      /* Start continuous color report trials */
      NextFeedTrial();
      return; // need return; otherwise the ShowTrial below executes
    } else if (currentTrial % trialsPerBlock == 0 && currentPart == 1) {
        $('#showTrial').show();
        $('#item').css('margin-top', -1000);
        $('#allItems').css('margin-top', 0);
        cdctx.drawImage(CDfix,0,0,600,600);
        numCD = 0; nextTrialStart = 1; currentTrial--;
        tempVar = true;
        ChangeDetection();
        return;
    }
  }
  nextTrialStart = 0;

  if (readyRepeat == 1 && waitObject != 2) {
    ShowTrial(repeatTriTrials[numRepeats]);
  } else {
    ShowTrial(r_totalTrials[currentPart][currentTrial]);
  }

}

/* Basic trial structure: Wait for click; then show the stimuli for this trial; then delay for fixed ISI; then call ShowContinuousReport */
function ShowTrial(trialStruct) {
    flip = 0;
    start(ctx,trialStruct.item,175, 175,imgWidth,imgHeight,flip,img);
    if (currentPart == 0) {
        img.src = $('#' + dx.pracimg[currentTrial])[0].src;
    } else if (readyRepeat == 1 && waitObject != 2) {
        img.src = $('#' + dx.repeatimg[numRepeats])[0].src;
    } else {
        img.src = $('#' + r_totalTrials[currentPart][currentTrial].itemID)[0].src;
    }

    $('#allItems').css('margin-top', -1000);
    $('#showTrial').show();
    setTimeout(function() {
        $('#allItems').css('margin-top', 0);
        setTimeout(function() {
            $('#allItems').css('margin-top', -1000);
            setTimeout(function() {
              $('#showTrial').hide();
                if (currentPart == 0) {
                    NextTrial();
                } else {
                    if (readyRepeat == 1) {
                      if (waitObject != 1) {
                        readyRepeat = 0;
                        RepeatTrial();
                      } else {
                        waitObject = 2;
                        NextTrial();
                      }
                    } else {
                      if (dx.r_repeattrial.includes(currentTrial)) {
                          waitObject = Math.random()<0.5? 0 : 1;
                          imgPop.src = $('#' + dx.repeatimg[numRepeats])[0].src;
                          if (currentTrial == numTrialsPerPart[1] - 1) { waitObject = 0; }
                          readyRepeat = 1; NextTrial();
                      } else {
                          readyRepeat = 0; NextTrial();
                      }
                    }
                }
            }, isiTime);
        }, displayTime);
    }, 500);
}

function RepeatTrial() { /* Should really be renamed abrupt-onset trial, not RepeatTrial */
  repeat = 1;
  $('#popQuiz').show();
  // alert('Pop quiz! What color was this object?');

  /*Preload color wheel, first practice trial will have randrotate=0 and flip=0*/
  ringctx.restore();
  ringctx.drawImage(ringImg,50,50,500,500);
  ringctx.save();

  ShowContinuousReport(repeatTriTrials[numRepeats]);

  /* Set starting color as grayscale */
  ctx2.drawImage(imgPop, 175, 175,imgWidth,imgHeight);
  recolor(ctx2,127.5,127.5,127.5,175, 175);
  mouseMoved = 0;
};

/* Show the next continuous color report trial: */
function NextFeedTrial() {
  if (blockStart == 0) {
    currentFeedTrial++;
    if (currentFeedTrial>numTrialsPerPart[currentPart]-1) {
      if (currentPart > 0) {
        $('showTrial').hide;
        Survey1();
        return;
      } else {
        currentFeedTrial = 0;
        currentPart++;
          alert("Okay, time for the real experiment. Please do your best to remember the colors of the subsequent objects, as you\'ll be tested on your memory for all of them by the end. You will receive a monetary bonus the better you perform. Thank you and we wish you the best of luck!");
          currentTrial = -1;
          imgX.src = $('#' + r_totalTrials[2][0].itemID)[0].src; /* preload first image of test phase */
          NextTrial();
          return;
      }
    } else if (currentFeedTrial % trialsPerBlock == 0 && currentPart == 2 && blockStart == 0) {
      currentPart = 1;
      /* Go back to study phase */
      alert("Starting study phase (Block "+block+" of "+totBlocks+").");
      imgX.src = $('#' + r_totalTrials[2][currentFeedTrial].itemID)[0].src; /* preload image */
      NextTrial();
      return;
    }
  } else {
    blockStart = 0;
  }

  /*Preload color wheel, first practice trial will have randrotate=0 and flip=0*/
  ringctx.restore();
  ringctx.drawImage(ringImg,50,50,500,500);
  ringctx.save();
  if (!(currentPart == 0 && currentFeedTrial == 0)) { //dont clear ring if its first time ever presented, otherwise first practice trial has no ring
    ringctx.clearRect(0, 0, 600, 600);
  }

  ShowContinuousReport(r_totalTrials[currentPart][currentFeedTrial]);
  mouseMoved = 0;
}

function ChangeDetection() { // filler change detection task before every test phase
  $('#underText2').hide();
  $('#SameButton').hide();
  $('#DiffButton').hide();

  if (numCD == 0) {
    confirm('Before we test your memory, please complete a short change detection task. You will see an array of colored squares appear for a brief moment. Then, one colored square will be presented. The task is to select whether the colored square is the same color or a different color than it was before.\n\nPress [ENTER] to continue.');
  }

  if (numCD < 2) {
      CDtrial++; numCD++;
      CDtrialChange();

      $('#showTrial').show();
      $('#item').css('margin-top', -1000);
      $('#allItems').css('margin-top', 0);
      $('#CDitem').show();

      cdctx.drawImage(CDfix,0,0,600,600);
      setTimeout(function(){  // after 800 ms, show colored memory array
        cdctx.drawImage(imgCD,0,0,600,600);
            setTimeout(function(){  // after 200 ms, show fixation again
              cdctx.drawImage(CDfix,0,0,600,600);
                    setTimeout(function(){  // after 900 ms, show test array
                            cdctx.drawImage(imgCDtest,0,0,600,600);
                            $('#underText2').show();
                            $('#SameButton').show();
                            $('#DiffButton').show();
                    }, 900);
            }, 200);
     }, 800);
   } else {
       currentPart = 2;
       $('#showTrial').hide();
       $('#item').css('margin-top', 0);
       $('#allItems').css('margin-top', -1000);
       $('#CDitem').hide();
       blockStart = 1;
       alert("Finished study phase of Block "+block+" of "+totBlocks+". You will now see all previous objects from this Block.\n\nMove your mouse around the color wheel and click your best guess of the original object color. Please be as precise as possible!");
       block = block + 1;
       NextFeedTrial();
   }
}

function SamePress() {
  if ([1,3,4,7,10,11,12,15,16,18].indexOf(CDtrial) > -1) { //if CDtrial equals any of the numbers in the array (representing same trials)
    CDaccuracy.push(1);
    numCD < 2 ? alert('Correct!\n\nPress [ENTER] to start change detection trial.') : alert('Correct!\n\nPress [ENTER] to continue.');
  } else {
    CDaccuracy.push(0);
    numCD < 2 ? alert('Incorrect...\n\nPress [ENTER] to start change detection trial.') : alert('Incorrect...\n\nPress [ENTER] to continue.');
  }
}
function DiffPress() {
  if ([1,3,4,7,10,11,12,15,16,18].indexOf(CDtrial) > -1) { //if CDtrial equals any of the numbers in the array (representing same trials)
    CDaccuracy.push(0);
    numCD < 2 ? alert('Incorrect...\n\nPress [ENTER] to start change detection trial.') : alert('Incorrect...\n\nPress [ENTER] to continue.');
  } else {
    CDaccuracy.push(1);
    numCD < 2 ? alert('Correct!\n\nPress [ENTER] to start change detection trial.') : alert('Correct!\n\nPress [ENTER] to continue.');
  }
}
function CDtrialChange() {
  if ([1,3,4,7,10,11,12,15,16,18].indexOf(CDtrial) > -1) {
    if (sameTally >= 9) {
      sameTally = -1;
    }
    sameTally = sameTally + 2;
    imgCD.src = $('#same'+sameTally)[0].src;
    imgCDtest.src = $('#same'+(sameTally+1))[0].src;
  } else {
    if (diffTally >= 7) {
      diffTally = -1;
    }
    diffTally = diffTally + 2;
    imgCD.src = $('#diff'+diffTally)[0].src;
    imgCDtest.src = $('#diff'+(diffTally+1))[0].src;
  }
}

/* Always track the mouse */
let mouseX, mouseY;
$(function() {
  $(document).bind('mousemove.overall', function(e) {
    mouseX = e.pageX;
    mouseY = e.pageY;
  });
});

function ShowContinuousReport(trialStruct) {
  angleDeg = 0;
  curError = 360;
  startTime = new Date();
  $("#continuousReport").show(); /* Refresh the page to update same context set to new img src */

  $(document).bind('mousemove.curTrial', function(e) {
      parentOffset = $('#continuousReport').offset();
      relX = e.pageX - parentOffset.left - centerX;
      relY = e.pageY - parentOffset.top - centerY;
      curAngle = Math.atan2(relY,relX);
      angleDeg = curAngle / Math.PI * 180.0;
      imgNum = Math.round(wrap([angleDeg-randrotate]));
      startingColor = imgNum;
      mouseMoved = 1;

      if (repeat == 0) {
        start(ctx2,imgNum,175, 175,imgWidth,imgHeight,flip,img);
      } else if (repeat == 1) {
        start(ctx2,imgNum,175, 175,imgWidth,imgHeight,flip,imgPop);
      }

      if (currentPart == 0) {
          img.src = $('#' + dx.pracimg[currentFeedTrial])[0].src;
      } else if (survey == 0 && repeat == 0) {
          img.src = $('#' + r_totalTrials[currentPart][currentFeedTrial].itemID)[0].src;
      } else if (survey == 1 && repeat == 0) {
          img.src = $('#999')[0].src;
          // Draw fixed 45 degree highlight
          ctx2.beginPath();
          ctx2.arc(centerX, centerY, radius, curAngle+180+Math.PI*4, curAngle, 1);
          ctx2.lineWidth = 50;
          ctx2.strokeStyle = 'white';
          ctx2.stroke();
          ctx2.beginPath();
          ctx2.arc(centerX, centerY, radius, curAngle+180-Math.PI*4, curAngle, 0);
          ctx2.lineWidth = 50;
          ctx2.strokeStyle = 'white';
          ctx2.stroke();
          ctx2.beginPath();
          ctx2.arc(centerX, centerY, radius, curAngle + Math.PI/4, curAngle, 1);
          ctx2.lineWidth = 40;
          ctx2.strokeStyle = 'black';
          ctx2.stroke();
          ctx2.beginPath();
          ctx2.arc(centerX, centerY, radius, curAngle - Math.PI/4, curAngle, 0);
          ctx2.lineWidth = 40;
          ctx2.strokeStyle = 'black';
          ctx2.stroke();
      }

      if (survey == 0) {
        $('#pointer').css({'left': centerX + Math.cos(curAngle)*ringSize-9,
                          'top': centerY + Math.sin(curAngle)*ringSize-9});
      } else {
        $('#pointer').hide();
      }

      if (survey == 1) {
        flip == 0? curError = Math.abs(wrap([imgNum-seed[0]])) : curError = Math.abs(wrap([wrap([180-imgNum])-seed[0]]));
      } else {
        flip == 0? curError = Math.abs(wrap([imgNum-trialStruct.item])) : curError = Math.abs(wrap([wrap([180-imgNum])-trialStruct.item]));
      }
      if (curError > 180) {
          curError = 360-curError;
      } else if (curError < -180) {
          curError = curError+360;
      }

      if (e.isFakeTrigger) { // this code only executes once before anything else happens, e.g. otherwise randrotate would be next trial's randrotate
        trialStruct.startingColor = startingColor;
        trialStruct.randrotate = randrotate;
        trialStruct.flip = flip;
        flip == 0? ringImg.src = $('#ring')[0].src : ringImg.src = $('#ringFlip')[0].src;
        ringctx.translate(50+500/2, 50+500/2);
        ringctx.rotate(randrotate*Math.PI/180);
        ringctx.translate(-50-500/2, -50-500/2);
        ringImg.onload = function() {
          ringctx.drawImage(ringImg,50,50,500,500);
        }
        ringctx.drawImage(ringImg,50,50,500,500); // have to code it twice because Safari hates .onload
        ctx2.onload = function() {
          start(ctx2,'gray',175, 175, imgWidth, imgHeight, flip, img); //set starting color as grayscale
        }
        start(ctx2,'gray',175, 175, imgWidth, imgHeight, flip, img);
      }
      if ((currentFeedTrial % trialsPerBlock) == 0) { // needed special code for first item of test phase showing as grayscale, no idea why
        if (tempVar) {
          setTimeout(function() {
            ctx2.onload = function() {
              start(ctx2,'gray',175, 175, imgWidth, imgHeight, flip, img); //set starting color as grayscale
            }
            start(ctx2,'gray',175, 175, imgWidth, imgHeight, flip, img);
          }, 150);
          tempVar = false;
        }
      }
  });

  $(document).bind('click.curTrial', function(e) {
      if (survey == 1) {
          explicitColor = flip == 0? Math.round(wrap([angleDeg-randrotate])) : Math.round(wrap([180-wrap([angleDeg-randrotate])]));
      } else if (currentPart == 2 && ((new Date()) - startTime) < 500) {
        if (currentFeedTrial % trialsPerBlock != 0) {
          alert('Please take your time when making responses! We will not be able to use your data if it is too noisy! Thanks.');
        }
        tooFast.push(1);
      }

      if (mouseMoved != 0) {
          trialStruct.reportedAngle = Math.round(angleDeg);
          trialStruct.reportedColor = flip == 0? Math.round(wrap([angleDeg-randrotate])) : Math.round(wrap([180-wrap([angleDeg-randrotate])]));
          trialStruct.rt = (new Date()) - startTime;
          trialStruct.trialTimeStart = startTime;
          trialStruct.col_diff = curError;
          $(document).unbind('click.curTrial');
          $(document).unbind('mousemove.curTrial');
          $("#continuousReport").hide();
          if (currentPart == 0 && currentFeedTrial == 0) {
            alert('Cool! Now highlight the smallest range of colors you think includes the true color. This is a confidence range to inform us experimenters about how certain you are of your answer.' +
            ' Click after you\'ve highlighted colors in one circular direction, and then we\'ll do the other direction.')
          }
          if (survey == 0) {
            ShowConfidence(trialStruct,angleDeg);
            $('#popQuiz').hide();
          } else {
            var expConfirm = confirm("Is this your selection? [Cancel] to redo.");
            if (expConfirm == true) {
              Survey3();
            } else {
              ShowContinuousReport({mean: seed[0], type: "color", isPractice: 0, items: 999});
              return;
            }
          }
      }
  });

  e = $.Event('mousemove');
  e.pageX = mouseX;
  e.pageY = mouseY;
  e.isFakeTrigger = true;
  $(document).trigger(e);
}

function ShowConfidence(trialStruct,angleDeg) {
    angleDeg2 = 0;
    startTime = new Date();
    startAngle = angleDeg * Math.PI / 180;
    lastRot = 0;
    noMore = 0;
    diffAng2 = -999;

    /* Confidence report */
    $(document).bind('mousemove.curTrial', function(e) {
        parentOffset = $('#continuousReport').offset();
        relX = e.pageX - parentOffset.left - centerX;
        relY = e.pageY - parentOffset.top - centerY;
        curAngle = Math.atan2(relY,relX);
        angleDeg2 = curAngle / Math.PI * 180.0;
        diffAng2 = wrap([wrap([angleDeg])-wrap([angleDeg2])])>180? wrap([wrap([angleDeg2])-wrap([angleDeg])]) : wrap([wrap([angleDeg])-wrap([angleDeg2])]);
        if (wrap([wrap([angleDeg])-wrap([angleDeg2])])<180 && noMore == 0) { /* conf is counterclockwise */
          ctx2.beginPath();
          ctx2.arc(centerX, centerY, radius, startAngle - Math.PI, curAngle, 1);
          ctx2.lineWidth = 50;
          ctx2.strokeStyle = 'white';
          ctx2.stroke();
          ctx2.beginPath();
          ctx2.arc(centerX, centerY, radius, startAngle, curAngle, 1);
          ctx2.lineWidth = 40;
          ctx2.strokeStyle = 'black';
          ctx2.stroke();
          ctx2.beginPath();
          ctx2.arc(centerX, centerY, radius, startAngle + Math.PI, curAngle, 0);
          ctx2.lineWidth = 50;
          ctx2.strokeStyle = 'white';
          ctx2.stroke();
          lastRot = 1; lastRotMat.push(lastRot);
        } else if (wrap([wrap([angleDeg])-wrap([angleDeg2])])>180 && noMore == 0) { /* conf is clockwise */
          ctx2.beginPath();
          ctx2.arc(centerX, centerY, radius, startAngle + Math.PI, curAngle, 0);
          ctx2.lineWidth = 50;
          ctx2.strokeStyle = 'white';
          ctx2.stroke();
          ctx2.beginPath();
          ctx2.arc(centerX, centerY, radius, startAngle, curAngle, 0);
          ctx2.lineWidth = 40;
          ctx2.strokeStyle = 'black';
          ctx2.stroke();
          ctx2.beginPath();
          ctx2.arc(centerX, centerY, radius, startAngle - Math.PI, curAngle, 1);
          ctx2.lineWidth = 50;
          ctx2.strokeStyle = 'white';
          ctx2.stroke();
          lastRot = 0; lastRotMat.push(lastRot);
        }
    });

    $(document).bind('click.curTrial', function(e) {
      if (currentPart == 0 && currentFeedTrial == 0 && noMore == 0) {
        if (lastRot == 0) {
          alert('Now finish your highlighting in the other circular direction. ' +
          ' Since you went clockwise so far, finish by clicking counterclockwise from your original best guess.')
        } else {
          alert('Now finish your highlighting in the other circular direction. ' +
          ' Since you went counterclockwise so far, finish by clicking clockwise from your original best guess.')
        }
      }
      trialStruct.rt2 = (new Date()) - startTime;
      ShowConfidence2(trialStruct,angleDeg,angleDeg2,diffAng2,lastRot);
      noMore = 1;
    })

    $("#continuousReport").show();
    e = $.Event('mousemove');
    e.pageX = mouseX;
    e.pageY = mouseY;
    e.isFakeTrigger = true;
    $(document).trigger(e);
}

function ShowConfidence2 (trialStruct,angleDeg,angleDeg2,diffAng2,lastRot) {
  angleDeg3 = 0;
  startTime = new Date();
  startAngle = angleDeg * Math.PI / 180;
  startAngle2 = angleDeg2 * Math.PI / 180;

  /* Confidence report */
  $(document).bind('mousemove.curTrial', function(e) {
      parentOffset = $('#continuousReport').offset();
      relX = e.pageX - parentOffset.left - centerX;
      relY = e.pageY - parentOffset.top - centerY;
      curAngle = Math.atan2(relY,relX);
      angleDeg3 = curAngle / Math.PI * 180.0;
      diffAng3 = wrap([wrap([angleDeg])-wrap([angleDeg3])])>180? wrap([wrap([angleDeg3])-wrap([angleDeg])]) : wrap([wrap([angleDeg])-wrap([angleDeg3])]);
      if (wrap([wrap([angleDeg])-wrap([angleDeg3])])<180+(180-diffAng2) && lastRot == 0) { /* conf is counterclockwise */
        ctx2.beginPath();
        ctx2.arc(centerX, centerY, radius, startAngle, curAngle, 1);
        ctx2.lineWidth = 40;
        ctx2.strokeStyle = 'black';
        ctx2.stroke();
        ctx2.beginPath();
        ctx2.arc(centerX, centerY, radius, startAngle + diffAng2*Math.PI/180, curAngle, 0);
        ctx2.lineWidth = 50;
        ctx2.strokeStyle = 'white';
        ctx2.stroke();
      } else if (wrap([wrap([angleDeg])-wrap([angleDeg3])])>180-(180-diffAng2) && lastRot == 1) { /* conf is clockwise */
        ctx2.beginPath();
        ctx2.arc(centerX, centerY, radius, startAngle, curAngle, 0);
        ctx2.lineWidth = 40;
        ctx2.strokeStyle = 'black';
        ctx2.stroke();
        ctx2.beginPath();
        ctx2.arc(centerX, centerY, radius, startAngle - diffAng2*Math.PI/180, curAngle, 1);
        ctx2.lineWidth = 50;
        ctx2.strokeStyle = 'white';
        ctx2.stroke();
      }
  });

  $(document).bind('click.curTrial', function(e) {
    ctx2.clearRect(0, 0, 600, 600); // erases the black highlighting
    /* Show approximate feedback: amazing! < 15, good! < 30 */
    if (trialStruct.isPractice) {
      $('#feedbackError').html("Your error was: " + Math.round(curError) + " deg (aim for less than 30 deg!)<br><br>Click to continue.");
    }
    if (curError <= 15) {
        feedText = 'Amazing!<br>(+$.01)';
        points = points + .01;
    } else if (curError <= 30) {
        feedText = 'Good!<br>(+$.005)';
        points = points + .005;
    } else {
        feedText = '...';
    }
    document.getElementById("fixation").innerHTML = feedText;
    $("#continuousReport").hide();
    $(document).unbind('click.curTrial');
    $(document).unbind('mousemove.curTrial');
    trialStruct.rt3 = (new Date()) - startTime;
    trialStruct.conf2 = diffAng2;
    trialStruct.conf3 = diffAng3;
      if (trialStruct.isPractice) {
          $('#feedbackError').html("Your error was: " + Math.round(curError) + " deg (aim for less than 30 deg.!)<br><br>Click to continue.");

          imgNum = Math.round(wrap([angleDeg-randrotate]));
          start(ctx3,imgNum,80,100, 200, 200, flip, img);
          imgNum = flip == 0? Math.round(trialStruct.item) : Math.round(wrap([180-trialStruct.item]));
          start(ctx4,imgNum,40,100, 200, 200, flip, img);

          if (currentFeedTrial+1 < numTrialsPerPart[0]) {
          img.src = $('#' + dx.pracimg[currentFeedTrial+1])[0].src;
          }
          ctx2.drawImage(img, 175, 175,imgWidth,imgHeight);

          ringctx.clearRect(50,50,500,500);
          flip = Math.round(Math.random());
          randrotate = Math.floor(Math.random()*360);

          $('#feedback').show();
          $(document).bind('click.feedback', function(e) {
              $('#feedback').hide();
              NextFeedTrial();
              document.getElementById("fixation").innerHTML = '+';
              $(document).unbind('click.feedback');
          });
      } else {
          $('#showTrial').show();
          if (repeat == 1) {
              imgPop.src = $('#' + dx.repeatimg[numRepeats])[0].src;
              numRepeats++;
          } else if (currentFeedTrial < numTrialsPerPart[1]-1) {
              img.src = $('#' + r_totalTrials[currentPart][currentFeedTrial+1].itemID)[0].src;
          } else if (currentFeedTrial>=numTrialsPerPart[currentPart]-1) { /* this is to prepare the gray square in explicit test */
              img.src = $('#999')[0].src;
          }
          ringctx.clearRect(50,50,500,500);
          flip = Math.round(Math.random());
          randrotate = Math.floor(Math.random()*360);

          setTimeout(function() {
              if (repeat == 0) { $('#showTrial').hide(); }
              repeat == 1? NextTrial() : NextFeedTrial();
              document.getElementById("fixation").innerHTML = '+';
          }, isiTime);
      }
  });
}

function Survey() {
  if (document.getElementById("surveyresponseRand").checked) {
      radioResp = 1;
  } else if (document.getElementById("surveyresponsePref").checked) {
      radioResp = 2;
  }
  //proceed only if they picked one of two options
  if (radioResp > 0) {
      $('#instructions').hide();

      // Now they have answered our multiple-coice question
      $("#survey2").hide();
      survey = 1;

      /*Preload color wheel, first practice trial will have randrotate=0 and flip=0*/
      ringctx.restore();
      ringctx.drawImage(ringImg,50,50,500,500);
      ringctx.save();

      if (radioResp == 1) {
        document.getElementById("underText").innerHTML = "We actually did manipulate what colors were presented. Specifically, 40% of objects were sampled from one quarter of the color wheel (90 degree region). Please select the range of colors you think matches our preferential color sampling.";
      } else if (radioResp == 2) {
        document.getElementById("underText").innerHTML = "Yes, we did manipulate what colors were presented. Specifically, 40% of objects were sampled from one quarter of the color wheel (90 degree region). Please select the range of colors you think matches our preferential color sampling.";
      }

      ShowContinuousReport({mean: seed[0], type: "color", isPractice: 0, items: 999});

      alert(document.getElementById("underText").innerHTML);
      mouseMoved = 0;
  } else {
      alert('Please select an option.');
  }
}

function Survey1() {
  $('#survey1').show();
}

function Survey2() {
  $('#survey1').hide();
  $("#survey2").show();
}

function Survey3() {
  $('#survey3').show();
}

/* Done with the experiment; wait for comments and for them to hit Save */
function Done() {
  //proceed only if they picked an option for survey3
  if (document.querySelector('input[name="likertz"]:checked').value > 0) {
      likertAns = document.querySelector('input[name="likertz"]:checked').value;
      $("#survey3").hide();
      $('#done').show();
      let cashpoints = points + basepay;
      document.getElementById("cashPrize").innerHTML = "Total earnings: $" + cashpoints.toFixed(2);
      points = points.toFixed(2); //round to 2 decimal places
  } else {
      alert('Please select an option.');
  }
}

/* Choose what to save and then put it on the server */
function SaveData() {
  $('#done').children().hide();
  $('#saving').show();
  $('#assignmentId').val(GetAssignmentId());
  const newDate = new Date();
  const d = {
    "WORKERID": WORKERID,
    "ASSIGNMENTID": ASSIGNMENTID,
    "curTime": newDate.today() + " @ " + newDate.timeNow(),
    "startExpTime": startExpTime,
    "endExpTime": newDate,
    "totalExpTime": newDate - startExpTime,
    "userAgent": navigator.userAgent,
    "windowWidth": $(window).width(),
    "windowHeight": $(window).height(),
    "screenWidth": screen.width,
    "screenHeight": screen.height,
    "comments": $('#comments').val(),
    "strategy": $('#strategy').val(),
    "pracTrials": r_totalTrials[0],
    "studyTrials": r_totalTrials[1],
    "testTrials": r_totalTrials[2],
    "radioResponse": radioResp,
    "explicitColor": explicitColor,
    "LikertAns": likertAns,
    "Bonus": points,
    "Seeds": seed,
    "StudyOrder": dx.r_study,
    "SeedOrder": dx.r_TrialType,
    "CDAccuracy": CDaccuracy,
    "firstConfDir": lastRotMat,
    "tooFastCount": tooFast,
    "Age": age,
    "Sex": sex
  };

    /* save to Firebase server */
    const blob = new Blob([JSON.stringify(d)], {type: "application/json"});
    const storageRef = firebase.storage().ref('data/' + WORKERID + '.json');
    storageRef.put(blob);

    document.getElementById("saving").innerHTML = "Submitting HIT...";

    // submit HIT after waiting a few seconds to make sure data got sent
    setTimeout(function(){ document.forms[0].submit(); }, 3000);
}

function start(context,deg,initX,initY,imgWidth,imgHeight,flip,image) {
    flip==0? colors=origColors : colors=flippedColors;
    let col = [127.5,127.5,127.5];
    if (deg != 'gray') {
        deg=(deg>=360)?deg-360:deg;
        deg=(deg<0)?deg+360:deg;
        col = colors[deg];
    }
    if (context == ctx3 || context == ctx4) {
      context.drawImage(image, initX, initY, imgWidth, imgHeight);
      recolor(context,Math.round(col[0]),Math.round(col[1]),Math.round(col[2]),initX,initY);
    } else {
      image.onload = function() {
        context.drawImage(image, initX, initY, imgWidth, imgHeight);
        recolor(context,Math.round(col[0]),Math.round(col[1]),Math.round(col[2]),initX,initY);
      }
      recolor(context,Math.round(col[0]),Math.round(col[1]),Math.round(col[2]),initX,initY);
    }
}
function recolor(context,newR,newG,newB,initX,initY) {
    imgData = context.getImageData(initX, initY, item.width, item.height);
    let data = imgData.data;
    for (let i = 0; i < data.length; i += 4) {
        let red = data[i];
        let green = data[i + 1];
        let blue = data[i + 2];
        if (red != 0 && red!= 255) {
            data[i] = newR;
            data[i + 1] = newG;
            data[i + 2] = newB;
        }
    }
    context.putImageData(imgData, initX, initY);
}

/* Make sure all numbers in an array are between 0 and 360: */
function wrap(v) {
  for (let i=0; i<v.length; i++) {
    if (v[i]>360) { v[i]-=360; }
    if (v[i]<0) { v[i]+=360; }
  }
  return v;
}

$(window).load(function () {
  $('#startExperimentButton').show();
  $('#loading').hide();
});

$(function() {
  if (navigator.userAgent.indexOf('MSIE') != -1) {
    $('body').html('Unfortunately this HIT does not work in IE. It works in Chrome, Firefox or Safari. Sorry!');
  }
});

</script>
</body></html>
